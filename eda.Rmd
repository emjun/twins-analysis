---
title: "EDA"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

Exploratory data analysis

Install and load dependencies
```{r}
list.of.packages <- c("knitr", "tidyverse", "ggplot2", "Rcpp", "gridExtra")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
library(gridExtra)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load data
```{r}
library(tidyverse)
# Load data
matched_children_df<-read.csv("./data/twins2013_matched_children.csv")
```

Clean data to only look at twins
```{r}
# Separate out twins
print('Original  dataset had rows:' + nrow(matched_children_df))
twins_only <- filter(matched_children_df, n_children == 2)
print('Only twins:' + nrow(twins_only))
```

Create dataset of one child per twin, trying to get unique mother info
```{r}
one_twin_only_df = distinct(twins_only, number,.keep_all = TRUE)
nrow(one_twin_only_df) # 53563


# Do not look for discrepancies
for(t in 1:length(twins_only$number)) {
  # While iterating through each twin, if there are discrepancies between mothers data, random choose which row of data to use
  
  # If no discrepancy, add first one to mothers_only df
}

# GOAL: mothers only should have data for all unique mothers in the dataset, easy for us to create bar charts giving an overview of the mothers health
```

RQ1: Difference in birth weight of twin pairs? - Create a dataframe for each twin pair showing their mother's info + difference in birth weight
Visualize mothers data for twins
```{r}
# mager41: mother's age - values 13 to 50 with 13-49 indicating 13-49 years old, 50 indicating 50-64 years old
# meduc: mother's education coded in 9 levels - 1: 8th grade or less; 2: 9th through 12th grade with no diploma; 3: High school graduate or GED completed; 4: Some college credit, but not a degree; 5: Associate degree (AA,AS); 6: Bachelor’s degree (BA, AB, BS); 7: Master’s degree (MA, MS, MEng, MEd, MSW, MBA); 8: Doctorate (PhD, EdD) or Professional Degree (MD, DDS, DVM, LLB, JD); 9: Unknown
# mracerec: mother's race coded in 4 levels: 1: White; 2: Black; 3: American Indian / Alaskan Native; 4: Asian / Pacific Islander
# wtgain: weight gain in pounds - 00-97: Weight gain in pounds; 98: 98 pounds and over; 99: Unknown or not stated
# cig_1: number of cigarettes daily during 1st Trimester - 00-97: Number of cigarettes daily; 98: 98 or more cigarettes daily; 99: Unknown or not stated   
# cig_2: number of cigarettes daily during 2nd Trimester - 00-97: Number of cigarettes daily; 98: 98 or more cigarettes daily; 99: Unknown or not stated
# cig_3: number of cigarettes daily during 3rd Trimester - 00-97: Number of cigarettes daily; 98: 98 or more cigarettes daily; 99: Unknown or not stated

# List all the colnames/variables for mothers that we are interested in
#mother_attrs = c("mager41", "meduc", "mracerec", "wtgain", "cig_1", "cig_2", "cig_3")
mother_attrs = list("mager41", "meduc") #, "mracerec", "wtgain", "cig_1", "cig_2", "cig_3")

plot_list = list()
for (i in 1:length(mother_attrs)) {
  var = names(mother_attrs)[i]
  print(var)
  print(ggplot(one_twin_only_df, aes(var)) +
  geom_histogram(binwidth = 1, stat="count"))
  #plot_list[[i]] <- p
  Sys.sleep(2)
}


```

# Save plots in one PDF
pdf("mothers_eda.pdf")
for (i in 1:length(mother_attrs)) {
    print(plot_list[[i]])
}
dev.off()

  
Reformat twins only data

Twins sex -- male, male | female, female | male, female

RQ2: Mortality rate? - Create  a df for each twin pair showing their mother's info + categorical encoding for mortality (looking at Death column)

RQ4: Create a df for each twin pair showing mother's info + categorical encoding for chromosomal abnormalities (both, one) for each chromosomal abnormality


```{r}
# Create a new wide dataframe
twins_only_numbers <- data.frame(number=character(),
                                 n_children=integer(),
                                 infant_id_og = character(), 
                                 birth_order = integer(), # originally called "lbo"
                                 infant_num = character(), # child number we create
                                 stringsAsFactors=FALSE) 

# For each unique Number
# If there are 2 children and lbo is 1 and 2
# Get unique twin/child group numbers
children_groups = unique(matched_children_df['number'])

for(i in 1:length(twins_only$number)) {
  curr_number = children_groups$number[i]
  
  children = filter(twins_only,  number == curr_number)
  
  if (length(children$n_children) == 2) {
    twins_only <- bind_rows(twins_only, children, .id=NULL)
  }
  
  if (length(children$n_children) > 2) {
    other <- bind_rows(other, children, .id=NULL)
  }
    
}

head(twins_only)
# Add each value 
```



Count and visualize number of twins vs. triplets vs. ...
```{r}

```

Visualize specific data columns of interest
Most twins in the dataset live (death == 0)
```{r}
ggplot(twins2013, aes(death)) +
  geom_histogram()
```

```{r}
# WIP. Need to figure out how to mutate plot_list in plot_histograms function
# Make plots
plot_histograms <- function(var, plot_list) {
  out <- tryCatch(
    {
      p = ggplot(one_twin_only_df, aes(as.integer(var))) +
          geom_histogram(binwidth = 1)
    },
    error=function(cond) {
      p = ggplot(one_twin_only_df, aes(as.factor(var))) +
          geom_histogram(binwidth = 1, stat="count")
    },
    finally={
      plot_list[[i]] <- p
      print(plot_list)
      sprintf('Done plotting %s', var)
    }
  )
  return(out)
}

plot_list <- lapply(mother_attrs, plot_histograms, plot_list)
typeof(y)
plot_list
```